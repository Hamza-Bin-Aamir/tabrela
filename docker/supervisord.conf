# ==============================================================================
# Tabrela - Supervisord Configuration
# ==============================================================================
# Manages all backend services within a single container.
#
# SECURITY MODEL:
# - supervisord runs as root (required for process management and log rotation)
# - All application services run as 'appuser' (uid 1001) for isolation
# - This is defense-in-depth: even if a service is compromised, it cannot
#   escalate to root privileges
# ==============================================================================

[supervisord]
nodaemon=true
user=root
logfile=/var/log/tabrela/supervisord.log
pidfile=/var/run/supervisord.pid
loglevel=info

[program:auth]
# Unset PORT so auth uses AUTH_PORT fallback (8081)
# Railway sets PORT=8080 for nginx, but we need auth on 8081
command=/usr/bin/env -u PORT /app/bin/auth
directory=/app
autostart=true
autorestart=true
stderr_logfile=/var/log/tabrela/auth.err.log
stdout_logfile=/var/log/tabrela/auth.out.log
user=appuser
environment=RUST_LOG="info"

[program:attendance]
# Unset PORT so attendance uses ATTENDANCE_PORT fallback (8082)
command=/usr/bin/env -u PORT /app/bin/attendance
directory=/app
autostart=true
autorestart=true
stderr_logfile=/var/log/tabrela/attendance.err.log
stdout_logfile=/var/log/tabrela/attendance.out.log
user=appuser
environment=RUST_LOG="info"

[program:merit]
# Unset PORT so merit uses MERIT_PORT fallback (8083)
command=/usr/bin/env -u PORT /app/bin/merit
directory=/app
autostart=true
autorestart=true
stderr_logfile=/var/log/tabrela/merit.err.log
stdout_logfile=/var/log/tabrela/merit.out.log
user=appuser
environment=RUST_LOG="info"

[program:tabulation]
command=/app/bin/tabulation
directory=/app
autostart=true
autorestart=true
stderr_logfile=/var/log/tabrela/tabulation.err.log
stdout_logfile=/var/log/tabrela/tabulation.out.log
user=appuser
environment=RUST_LOG="info"

[program:email]
# Email service runs on port 5000 - INTERNAL ONLY (not exposed to host)
# Uses gunicorn WSGI server for production
# Uses virtual environment for Python version independence
command=/app/email/venv/bin/gunicorn --bind 0.0.0.0:5000 --workers 2 --timeout 120 app:app
directory=/app/email
autostart=true
autorestart=true
stderr_logfile=/var/log/tabrela/email.err.log
stdout_logfile=/var/log/tabrela/email.out.log
user=appuser
environment=RESEND_API_KEY="%(ENV_RESEND_API_KEY)s",SERVICE_API_KEY="%(ENV_SERVICE_API_KEY)s",FROM_EMAIL="%(ENV_FROM_EMAIL)s",FRONTEND_URL="%(ENV_FRONTEND_URL)s"
# Virtual environment handles PYTHONPATH automatically

[program:webhook]
# Webhook service runs on port 5001 - handles Railway deployment webhooks
# Triggers GitHub Actions to deploy frontend after successful backend deployment
command=/app/webhook/venv/bin/gunicorn --bind 0.0.0.0:5001 --workers 1 --timeout 30 app:app
directory=/app/webhook
autostart=true
autorestart=true
stderr_logfile=/var/log/tabrela/webhook.err.log
stdout_logfile=/var/log/tabrela/webhook.out.log
user=appuser
environment=GITHUB_TOKEN="%(ENV_GITHUB_TOKEN)s",GITHUB_REPO="%(ENV_GITHUB_REPO)s",WEBHOOK_SECRET="%(ENV_WEBHOOK_SECRET)s"

[program:nginx]
# Nginx reverse proxy - routes requests to internal services
# Listens on 8080 (the only exposed port)
command=/usr/sbin/nginx -g "daemon off;"
autostart=true
autorestart=true
stderr_logfile=/var/log/tabrela/nginx.err.log
stdout_logfile=/var/log/tabrela/nginx.out.log
# nginx must run as root to bind to ports, but workers run as nginx user
user=root
priority=100
