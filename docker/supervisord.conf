# ==============================================================================
# Tabrela - Supervisord Configuration
# ==============================================================================
# Manages all backend services within a single container.
#
# SECURITY MODEL:
# - supervisord runs as root (required for process management and log rotation)
# - All application services run as 'appuser' (uid 1001) for isolation
# - This is defense-in-depth: even if a service is compromised, it cannot
#   escalate to root privileges
# ==============================================================================

[supervisord]
nodaemon=true
user=root
logfile=/var/log/tabrela/supervisord.log
pidfile=/var/run/supervisord.pid
loglevel=info

[program:auth]
command=/app/bin/auth
directory=/app
autostart=true
autorestart=true
stderr_logfile=/var/log/tabrela/auth.err.log
stdout_logfile=/var/log/tabrela/auth.out.log
user=appuser
environment=RUST_LOG="info"

[program:attendance]
command=/app/bin/attendance
directory=/app
autostart=true
autorestart=true
stderr_logfile=/var/log/tabrela/attendance.err.log
stdout_logfile=/var/log/tabrela/attendance.out.log
user=appuser
environment=RUST_LOG="info"

[program:merit]
command=/app/bin/merit
directory=/app
autostart=true
autorestart=true
stderr_logfile=/var/log/tabrela/merit.err.log
stdout_logfile=/var/log/tabrela/merit.out.log
user=appuser
environment=RUST_LOG="info"

[program:email]
# Email service runs on port 5000 - INTERNAL ONLY (not exposed to host)
# Uses gunicorn WSGI server for production
# Uses virtual environment for Python version independence
command=/app/email/venv/bin/gunicorn --bind 0.0.0.0:5000 --workers 2 --timeout 120 app:app
directory=/app/email
autostart=true
autorestart=true
stderr_logfile=/var/log/tabrela/email.err.log
stdout_logfile=/var/log/tabrela/email.out.log
user=appuser
environment=RESEND_API_KEY="%(ENV_RESEND_API_KEY)s",SERVICE_API_KEY="%(ENV_SERVICE_API_KEY)s",FROM_EMAIL="%(ENV_FROM_EMAIL)s",FRONTEND_URL="%(ENV_FRONTEND_URL)s"
# Virtual environment handles PYTHONPATH automatically
